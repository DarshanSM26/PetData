<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vet Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
</head>
<body class="container mt-5">

<h2 class="mb-4 text-center">Vet Dashboard</h2>

<!-- Vet selector (only visible if no login) -->
<div id="vetSelector" class="mb-3 d-none">
    <label class="form-label">Select Vet</label>
    <select id="vetSelect" class="form-select"></select>
</div>

<!-- List of Bookings -->
<div id="appointments" class="list-group"></div>

<!-- Pet Health Form -->
<div id="petHealthForm" class="mt-5 d-none">
    <h4>Fill Pet Health Record</h4>
    <form id="healthForm" class="border p-3 rounded shadow-sm">
        <div class="mb-3">
            <label class="form-label">Symptoms</label>
            <textarea id="symptoms" class="form-control" required></textarea>
        </div>
        <div class="mb-3">
            <label class="form-label">Diagnosis</label>
            <textarea id="diagnosis" class="form-control" required></textarea>
        </div>
        <div class="mb-3">
            <label class="form-label">Treatment</label>
            <textarea id="treatment" class="form-control" required></textarea>
        </div>
        <button type="submit" class="btn btn-success w-100">Save Health Record</button>
    </form>
    <div id="formMessage" class="mt-3"></div>
</div>

<script>
    const BOOKING_API = "http://localhost:8080/demo/appointments";
    const PETHEALTH_API = "http://localhost:8080/demo/pethealth";
    let selectedBookingId = null;

    // Open Pet Health Form for selected booking
    function openHealthForm(bookingId) {
      selectedBookingId = bookingId;
      document.getElementById("petHealthForm").classList.remove("d-none");
    }

    // Show appointments for a specific vet
    function showVetAppointments(bookings, vetName) {
      let container = document.getElementById("appointments");
      container.innerHTML = "";

      bookings
        .filter(b => b.vetName === vetName)
        .forEach(b => {
          let item = document.createElement("button");
          item.className = "list-group-item list-group-item-action";
          item.textContent = `${b.pet.name} (${b.date}) - Owner: ${b.pet.ownerName}`;
          item.onclick = () => openHealthForm(b.bookingId);
          container.appendChild(item);
        });
    }

    // Load all appointments
    async function loadAppointments() {
      try {
        let res = await fetch(BOOKING_API);
        let bookings = await res.json();

        // check if vet already logged in
        let loggedInVet = sessionStorage.getItem("vetName");

        if (loggedInVet) {
          // logged in vet -> show only their bookings
          document.getElementById("vetSelector").classList.add("d-none");
          showVetAppointments(bookings, loggedInVet);
        } else {
          // no login -> show vet dropdown
          document.getElementById("vetSelector").classList.remove("d-none");
          let vets = [...new Set(bookings.map(b => b.vetName))];
          let vetSelect = document.getElementById("vetSelect");
          vetSelect.innerHTML = vets.map(v => `<option value="${v}">${v}</option>`).join("");

          vetSelect.onchange = () => showVetAppointments(bookings, vetSelect.value);

          // load first vet's appointments by default
          if (vets.length > 0) {
            vetSelect.value = vets[0];
            showVetAppointments(bookings, vets[0]);
          }
        }
      } catch (err) {
        console.error("Failed to load appointments", err);
      }
    }

    // Handle health form submission
    document.getElementById("healthForm").addEventListener("submit", async function(e) {
      e.preventDefault();

      let petHealth = {
        symptoms: document.getElementById("symptoms").value,
        diagnosis: document.getElementById("diagnosis").value,
        treatment: document.getElementById("treatment").value
      };

      try {
        let res = await fetch(`${PETHEALTH_API}/${selectedBookingId}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(petHealth)
        });

        if (res.ok) {
          document.getElementById("formMessage").innerHTML =
            `<div class="alert alert-success">✅ Health record saved successfully!</div>`;
        } else {
          document.getElementById("formMessage").innerHTML =
            `<div class="alert alert-danger">❌ Failed to save health record</div>`;
        }
      } catch (err) {
        document.getElementById("formMessage").innerHTML =
          `<div class="alert alert-danger">⚠️ Error: ${err.message}</div>`;
      }
    });

    // Load on page ready
    document.addEventListener("DOMContentLoaded", () => loadAppointments());
</script>
</body>
</html>
